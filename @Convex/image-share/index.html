<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Share</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 12px; }
    
    .upload-section { 
      background: white; 
      padding: 16px; 
      border-radius: 12px; 
      margin-bottom: 16px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .upload-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }
    
    input[type="file"] { 
      display: none;
    }
    
    button { 
      padding: 12px 24px; 
      background: #007bff; 
      color: white; 
      border: none; 
      border-radius: 0; 
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    button:hover { background: #0056b3; }
    button:active { transform: scale(0.98); }
    
    button.danger { 
      background: #dc3545;
    }
    
    button.danger:hover { background: #c82333; }
    
    button.has-files {
      background: #ff8c00;
    }
    
    button.has-files:hover {
      background: #e67e00;
    }    
    #status {
      width: 100%;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .progress-container {
      width: 100%;
      margin-top: 10px;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #007bff;
      transition: width 0.3s;
      border-radius: 4px;
    }
    
    .progress-text {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    
    .gallery { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
      gap: 16px; 
    }
    
    .image-card { 
      background: white; 
      border-radius: 12px; 
      overflow: hidden; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    
    .image-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .image-card img { 
      width: 100%; 
      height: 220px; 
      object-fit: cover; 
      cursor: pointer; 
    }
    
    .image-info { padding: 12px; }
    .image-info p { font-size: 13px; color: #666; margin-bottom: 8px; }
    .image-info button { padding: 8px 16px; font-size: 13px; width: 100%; }
    .loading { text-align: center; padding: 40px; color: #999; font-size: 15px; }
    
    @media (max-width: 640px) {
      .container { padding: 8px; }
      .upload-section { padding: 12px; }
      .gallery { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
      .image-card img { height: 150px; }
      .file-label { min-width: 100%; font-size: 14px; }
      button { padding: 10px 18px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="upload-section">
      <div class="upload-controls">
        <input type="file" id="fileInput" multiple accept="image/*" onchange="updateFileCount()">
        <button id="uploadBtn" onclick="handleUpload()">Upload</button>
        <button class="danger" onclick="clearAll()">Clear All</button>
      </div>
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText"></div>
      </div>
      <div id="status"></div>
    </div>

    <div id="gallery" class="gallery"></div>
  </div>

  <script type="module">
    import { ConvexHttpClient } from "https://esm.sh/convex@1.16.0/browser";
    
    // REPLACE WITH YOUR CONVEX URL
    const CONVEX_URL = "https://modest-goose-860.convex.cloud";
    
    // REPLACE WITH YOUR CLOUDINARY CREDENTIALS
    const CLOUDINARY_CLOUD_NAME = "dwc7hjiub";
    const CLOUDINARY_UPLOAD_PRESET = "myGallery";
    
    const client = new ConvexHttpClient(CONVEX_URL);
    
    window.updateFileCount = function() {
      const files = document.getElementById('fileInput').files;
      const count = files.length;
      const btn = document.getElementById('uploadBtn');
      if (count) {
        btn.textContent = `Upload (${count})`;
        btn.classList.add('has-files');
      } else {
        btn.classList.remove('has-files');
      }
    };
    
    window.handleUpload = function() {
      const files = document.getElementById('fileInput').files;
      if (!files.length) {
        document.getElementById('fileInput').click();
      } else {
        uploadImages();
      }
    };
    
    window.uploadImages = async function() {
      const files = document.getElementById('fileInput').files;
      if (!files.length) return;
      
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const status = document.getElementById('status');
      
      progressContainer.style.display = 'block';
      status.textContent = '';
      
      const total = files.length;
      let completed = 0;
      
      for (const file of files) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        formData.append('folder', 'myGallery');
        
        try {
          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
            method: 'POST',
            body: formData
          });
          
          const data = await res.json();
          
          await client.mutation("images:add", { 
            url: data.secure_url,
            filename: file.name
          });
          
          completed++;
          const percent = Math.round((completed / total) * 100);
          progressFill.style.width = percent + '%';
          progressText.textContent = `${completed} of ${total} uploaded`;
        } catch (error) {
          console.error('Upload failed:', error);
        }
      }
      
      status.textContent = 'Upload complete!';
      status.style.color = '#28a745';
      setTimeout(() => {
        status.textContent = '';
        progressContainer.style.display = 'none';
        progressFill.style.width = '0%';
      }, 2000);
      document.getElementById('fileInput').value = '';
      document.getElementById('uploadBtn').textContent = 'Upload';
      document.getElementById('uploadBtn').classList.remove('has-files');
    };
    
    window.deleteImage = async function(id) {
      if (!confirm('Delete this image?')) return;
      await client.mutation("images:remove", { id });
    };
    
    window.clearAll = async function() {
      if (!confirm('Delete all images?')) return;
      await client.mutation("images:clear");
    };
    
    window.openImage = function(url) {
      window.open(url, '_blank');
    };
    
    function renderImages(images) {
      const gallery = document.getElementById('gallery');
      
      if (!images.length) {
        gallery.innerHTML = '<div class="loading">No images yet</div>';
        return;
      }
      
      gallery.innerHTML = images.map(img => `
        <div class="image-card">
          <img src="${img.url}" alt="${img.filename}" onclick="openImage('${img.url}')">
          <div class="image-info">
            <p><strong>${img.filename}</strong></p>
            <p>${new Date(img.timestamp).toLocaleString()}</p>
            <button class="danger" onclick="deleteImage('${img._id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }
    
    async function loadImages() {
      const images = await client.query("images:list");
      renderImages(images);
    }
    
    loadImages();
    client.onUpdate("images:list", {}, renderImages);
  </script>
</body>
</html>
